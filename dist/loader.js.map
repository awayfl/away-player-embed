{"version":3,"file":"loader.js","sources":["../src/loader/decompress.ts","../src/loader/fetcher.ts","../src/loader/reporter.ts","../src/loader/index.ts","../src/loader/loader.ts","../src/loader/progressUI.ts","../src/loader/runner.ts"],"sourcesContent":["export var supportDecoderApi = ('DecompressionStream' in self);\r\nexport var isSWC = function (head) { return (head[0] === 0x43 && head[1] === 0x57 && head[2] === 0x53); };\r\nexport var outputSize = function (head) { return new DataView(head.buffer).getUint32(4, true); };\r\n/*\r\ndeclare global {\r\n    interface Window { DecompressionStream: any; }\r\n}*/\r\nexport function Decoder(size, offset) {\r\n    if (offset === void 0) { offset = 8; }\r\n    if (!supportDecoderApi) {\r\n        throw 'Your browser not support DecompressionStream =(';\r\n    }\r\n    var decoder = new self.DecompressionStream('deflate');\r\n    var decoderW = decoder.writable.getWriter();\r\n    var decoderR = decoder.readable.getReader();\r\n    var buffer = new Uint8Array(size);\r\n    var isRunned = false;\r\n    var isDone = false;\r\n    var donableCallback;\r\n    function run() {\r\n        decoderR.read().then(function next(state) {\r\n            var done = state.done;\r\n            var value = state.value;\r\n            if (value) {\r\n                buffer.set(value, offset);\r\n                //console.debug(\"[Loader] Decoded chunk:\", offset);\r\n                offset += value.length;\r\n            }\r\n            if (done || offset >= size) {\r\n                isDone = true;\r\n                if (donableCallback) {\r\n                    donableCallback();\r\n                }\r\n                console.debug(\"[Loader] Decoder closed:\", offset);\r\n                return;\r\n            }\r\n            return decoderR.read().then(next);\r\n        });\r\n    }\r\n    return {\r\n        get buffer() {\r\n            return buffer;\r\n        },\r\n        write: function (buffer) {\r\n            decoderW.ready.then(function () {\r\n                decoderW.write(buffer);\r\n                if (!isRunned) {\r\n                    isRunned = true;\r\n                    run();\r\n                }\r\n            });\r\n        },\r\n        readAll: function () {\r\n            if (isDone) {\r\n                return Promise.resolve(buffer);\r\n            }\r\n            return new Promise(function (res) {\r\n                donableCallback = function () {\r\n                    res(buffer);\r\n                };\r\n            });\r\n        }\r\n    };\r\n}\r\n","import { supportDecoderApi, isSWC, outputSize, Decoder } from './decompress';\r\nexport function Fetcher(url, progress) {\r\n    if (url === void 0) { url = ''; }\r\n    if (progress === void 0) { progress = function (f) { return f; }; }\r\n    var total = 0;\r\n    var reader;\r\n    var chunks = [];\r\n    progress && progress(0);\r\n    return fetch(url)\r\n        .then(function (request) {\r\n        total = +request.headers.get('Content-Length');\r\n        reader = request.body.getReader();\r\n        return reader.read();\r\n    })\r\n        .then(function (data) {\r\n        var firstChunk = data.value;\r\n        console.debug(\"[Loader] Header:\", String.fromCharCode.apply(null, firstChunk.slice(0, 3).reverse()));\r\n        var loaded = 0;\r\n        var decoder;\r\n        if (supportDecoderApi && isSWC(firstChunk)) {\r\n            var totalDecodedSize = outputSize(firstChunk);\r\n            var swcHeader = firstChunk.slice(0, 8);\r\n            swcHeader[0] = 70; // SWC => SWF\r\n            console.debug(\"[Loader] SWC size:\", outputSize(firstChunk));\r\n            decoder = Decoder(totalDecodedSize, 8);\r\n            decoder.buffer.set(swcHeader);\r\n            // push witout header\r\n            decoder.write(firstChunk.slice(8));\r\n        }\r\n        else {\r\n            chunks.push(firstChunk);\r\n        }\r\n        loaded += firstChunk.length;\r\n        progress && progress(Math.min(1, loaded / total));\r\n        // update all other chunks reqursive while !done\r\n        return reader.read().then(function moveNext(state) {\r\n            if (state.done) {\r\n                if (!decoder) {\r\n                    var buffer_1 = new Uint8Array(loaded);\r\n                    var offset_1 = 0;\r\n                    chunks.forEach(function (e) {\r\n                        buffer_1.set(e, offset_1);\r\n                        offset_1 += e.length;\r\n                    });\r\n                    return buffer_1;\r\n                }\r\n                else {\r\n                    return decoder.readAll();\r\n                }\r\n            }\r\n            var value = state.value;\r\n            loaded += value.length;\r\n            progress && progress(loaded / total);\r\n            if (!decoder) {\r\n                chunks.push(value);\r\n            }\r\n            else {\r\n                decoder.write(value);\r\n            }\r\n            return reader.read().then(moveNext);\r\n        });\r\n    });\r\n}\r\nexport function loadBinary(file, progressEvent) {\r\n    if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\r\n    var isScript = file.path.indexOf(\".js\") > -1;\r\n    if (!isScript && supportDecoderApi) {\r\n        return Fetcher(file.path, progressEvent).then(function (buffer) {\r\n            return Object.assign(file, {\r\n                data: buffer.buffer,\r\n                type: \"swf\",\r\n            });\r\n        });\r\n    }\r\n    var req = new XMLHttpRequest();\r\n    req.addEventListener(\"progress\", function (e) {\r\n        // get from progress, then from request, and if not valid - from file\r\n        var total = e.total\r\n            || +req.getResponseHeader(\"content-length\")\r\n            || file.size\r\n            || 0;\r\n        if (!total) {\r\n            progressEvent(1);\r\n            return;\r\n        }\r\n        console.log(\"XHR\", e.loaded, total);\r\n        progressEvent(Math.min(1, e.loaded / total));\r\n    });\r\n    req.open(\"GET\", file.path, true);\r\n    req.responseType = isScript ? \"text\" : \"arraybuffer\";\r\n    return new Promise(function (res, rej) {\r\n        req.addEventListener(\"error\", rej);\r\n        req.addEventListener(\"load\", function () {\r\n            progressEvent(1);\r\n            if (isScript) {\r\n                // unsafe\r\n                //eval(req.response);\r\n                var b = new Blob([req.response], { type: \"text/javascript\" });\r\n                // use blob\r\n                loadScript(URL.createObjectURL(b)).then(function () { return res(undefined); });\r\n                return;\r\n            }\r\n            res({\r\n                meta: file.meta || {},\r\n                name: file.name,\r\n                path: file.path,\r\n                resourceType: file.resourceType,\r\n                data: req.response,\r\n                type: isScript ? \"js\" : \"swf\",\r\n            });\r\n        });\r\n        req.send();\r\n    });\r\n}\r\nexport function loadScript(file, progress) {\r\n    var head = document.querySelector(\"head\");\r\n    var script = document.createElement(\"script\");\r\n    return new Promise(function (res, rej) {\r\n        Object.assign(script, {\r\n            type: \"text/javascript\",\r\n            async: true,\r\n            src: typeof file === 'string' ? file : file.path,\r\n            onload: function () {\r\n                progress && progress(1);\r\n                res(script);\r\n            },\r\n            onerror: rej,\r\n        });\r\n        head.appendChild(script);\r\n    });\r\n}\r\n","var Reporter = /** @class */ (function () {\r\n    function Reporter(callback, _childs, weight) {\r\n        if (weight === void 0) { weight = 1; }\r\n        this.callback = callback;\r\n        this.weight = weight;\r\n        this.id = Reporter.ID++;\r\n        this.value = 0;\r\n        this._childs = [];\r\n        this._report = this._report.bind(this);\r\n        this.childs = _childs;\r\n    }\r\n    Object.defineProperty(Reporter.prototype, \"childs\", {\r\n        get: function () {\r\n            return this._childs;\r\n        },\r\n        set: function (chs) {\r\n            for (var _i = 0, _a = this._childs; _i < _a.length; _i++) {\r\n                var old = _a[_i];\r\n                if (old.callback === this._report) {\r\n                    old.callback = null;\r\n                }\r\n            }\r\n            this._childs.length = 0;\r\n            if (chs) {\r\n                for (var _b = 0, chs_1 = chs; _b < chs_1.length; _b++) {\r\n                    var c = chs_1[_b];\r\n                    if (c === this)\r\n                        throw 'Reporter loop';\r\n                    c.callback = this._report;\r\n                }\r\n                this._childs = chs.slice();\r\n            }\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Reporter.prototype._report = function (v) {\r\n        if (this._childs.length === 0) {\r\n            this.value = v * this.weight;\r\n        }\r\n        else {\r\n            var summ_1 = 0;\r\n            var v_1 = 0;\r\n            this._childs.forEach(function (e) {\r\n                summ_1 += e.weight || 1;\r\n                v_1 += (e.value || 0);\r\n            });\r\n            this.value = v_1 / summ_1;\r\n        }\r\n        this.callback && this.callback(this.value);\r\n    };\r\n    Object.defineProperty(Reporter.prototype, \"report\", {\r\n        get: function () {\r\n            return this._report;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Reporter.ID = 0;\r\n    return Reporter;\r\n}());\r\nexport { Reporter };\r\n","import { Loader } from \"./loader\";\r\nimport { ProgressUI } from \"./progressUI\";\r\nimport { Runner } from \"./runner\";\r\nimport { Reporter } from \"./reporter\";\r\nexport { Loader, Runner, ProgressUI, Reporter };\r\nvar runner;\r\nvar loader;\r\nvar ui;\r\nexport var LegacyLoader = {\r\n    init: function (_gameConfig) {\r\n        loader = new Loader(_gameConfig);\r\n        runner = new Runner(loader, _gameConfig);\r\n        ui = new ProgressUI(document, _gameConfig);\r\n        ui.init();\r\n        window[\"setStageDimensions\"] = function (x, y, w, h) {\r\n            _gameConfig.x = x;\r\n            _gameConfig.y = y;\r\n            _gameConfig.w = w;\r\n            _gameConfig.h = h;\r\n            if (window[\"AVMPlayerPoki\"]) {\r\n                window[\"AVMPlayerPoki\"].setStageDimensions(x, y, w, h);\r\n            }\r\n            ui.onUpdate();\r\n        };\r\n    },\r\n    runGame: function (progressEvent, completeEvent) {\r\n        if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\r\n        if (completeEvent === void 0) { completeEvent = function (data, gameRunEvent) { return 0; }; }\r\n        var conf = runner.config;\r\n        var progress = function (f) {\r\n            console.log(\"progress:\", f);\r\n            ui.onProgress(f);\r\n            progressEvent(f);\r\n        };\r\n        var complete = function (func) {\r\n            // rereport\r\n            // completeEvent(func);\r\n            if (conf.start) {\r\n                //\tstart image exists.\r\n                //\thide progressbar, show startimage and wait for user-input to start the game\r\n                ui.ready();\r\n                var onCLick = function (_e) {\r\n                    ui.hide(true);\r\n                    if (!func)\r\n                        throw \"PokiPlayer did not send a callback for starting game\";\r\n                    func();\r\n                };\r\n                window.addEventListener(\"click\", onCLick, { once: true });\r\n            }\r\n            else {\r\n                ui.hide(true);\r\n            }\r\n        };\r\n        // make functions avilailable on window, so the loaded js-code can access and execute them\r\n        Object.assign(window, {\r\n            swfParseComplete: complete,\r\n        });\r\n        return runner\r\n            .runGame(progress)\r\n            .then(function (res) {\r\n            completeEvent(res, complete);\r\n        });\r\n    }\r\n};\r\n","import { loadBinary, loadScript } from \"./fetcher\";\r\nimport { Reporter } from \"./reporter\";\r\nvar Loader = /** @class */ (function () {\r\n    function Loader(config) {\r\n        this.config = config;\r\n    }\r\n    ;\r\n    Loader.prototype.run = function (jsFiles, binaryFiles, progressEvent, _debugScripts) {\r\n        if (progressEvent === void 0) { progressEvent = function (_f) { return void 0; }; }\r\n        if (_debugScripts === void 0) { _debugScripts = false; }\r\n        var jsCount = jsFiles.length;\r\n        var binCount = binaryFiles.length;\r\n        var all = jsFiles.concat(binaryFiles);\r\n        var reporters = Array.from({ length: jsCount + binCount }, function () { return new Reporter(); });\r\n        this.progress = new Reporter(progressEvent, reporters);\r\n        var pendings;\r\n        if (!_debugScripts) {\r\n            pendings = all.map(function (e, i) { return loadBinary(e, reporters[i].report); });\r\n        }\r\n        else {\r\n            pendings = binaryFiles.map(function (e, i) { return loadBinary(e, reporters[i].report); });\r\n            pendings = pendings.concat(jsFiles.map(function (e, i) { return loadScript(e, reporters[i + binCount].report); }));\r\n        }\r\n        return Promise.all(pendings).then(function (data) {\r\n            return data.filter(function (e) { return e && e.type === \"swf\"; });\r\n        });\r\n    };\r\n    return Loader;\r\n}());\r\nexport { Loader };\r\n","var transformRel = function (val, base) {\r\n    if (typeof val !== 'string')\r\n        return +val;\r\n    return val.includes(\"%\")\r\n        ? (parseFloat(val) / 100) * base\r\n        : parseFloat(val);\r\n};\r\nvar ProgressUI = /** @class */ (function () {\r\n    function ProgressUI(root, config) {\r\n        if (root === void 0) { root = document; }\r\n        this.root = root;\r\n        this.config = config;\r\n        this.onUpdate = this.onUpdate.bind(this);\r\n        this.onProgress = this.onProgress.bind(this);\r\n        window.addEventListener(\"resize\", this.onUpdate);\r\n    }\r\n    ProgressUI.prototype.build = function () {\r\n        this.splash = this.root.querySelector(\"#splash__image\");\r\n        this.prRoot = this.root.querySelector(\"#progress__root\");\r\n        this.prLine = this.root.querySelector(\"#progress__line\");\r\n    };\r\n    ProgressUI.prototype.init = function () {\r\n        this.build();\r\n        if (!this.splash) {\r\n            return;\r\n        }\r\n        var config = this.config;\r\n        Object.assign(this.splash.style, {\r\n            backgroundImage: \"url(\".concat(config.splash, \")\"),\r\n            visibility: \"visible\",\r\n        });\r\n        var pr_conf = config.progress;\r\n        pr_conf.rect = pr_conf.rect || [0.1, 0.9, 0.8, 0.01];\r\n        Object.assign(this.prRoot.style, {\r\n            background: pr_conf.back,\r\n            left: \"\".concat(100 * pr_conf.rect[0], \"%\"),\r\n            top: \"\".concat(100 * pr_conf.rect[1], \"%\"),\r\n            width: \"\".concat(100 * pr_conf.rect[2], \"%\"),\r\n            height: \"\".concat(100 * pr_conf.rect[3], \"%\"),\r\n        });\r\n        Object.assign(this.prLine.style, {\r\n            background: pr_conf.line,\r\n        });\r\n        this.onUpdate();\r\n    };\r\n    ProgressUI.prototype.onProgress = function (p) {\r\n        if (!this.prLine) {\r\n            return;\r\n        }\r\n        var pr_conf = this.config.progress;\r\n        switch (pr_conf.direction) {\r\n            case \"tb\": {\r\n                Object.assign(this.prLine.style, {\r\n                    height: \"\".concat(p * 100, \"%\"),\r\n                    width: \"100%\",\r\n                });\r\n                break;\r\n            }\r\n            case \"lr\":\r\n            default: {\r\n                Object.assign(this.prLine.style, {\r\n                    height: \"100%\",\r\n                    width: \"\".concat(p * 100, \"%\"),\r\n                });\r\n            }\r\n        }\r\n    };\r\n    ProgressUI.prototype.onUpdate = function () {\r\n        if (!this.splash) {\r\n            return;\r\n        }\r\n        var config = this.config;\r\n        var x = transformRel(config.x, window.innerWidth) || 0;\r\n        var y = transformRel(config.y, window.innerHeight) || 0;\r\n        var w = transformRel(config.w, window.innerWidth) || window.innerWidth;\r\n        var h = transformRel(config.h, window.innerHeight) || window.innerHeight;\r\n        var minMax = Math.min(h / config.height, w / config.width);\r\n        var rw = Math.ceil(config.width * minMax);\r\n        var rh = Math.ceil(config.height * minMax);\r\n        var rx = x + (w - rw) / 2;\r\n        var ry = y + (h - rh) / 2;\r\n        Object.assign(this.splash.style, {\r\n            width: \"\".concat(rw, \"px\"),\r\n            height: \"\".concat(rh, \"px\"),\r\n            left: \"\".concat(rx, \"px\"),\r\n            top: \"\".concat(ry, \"px\"),\r\n        });\r\n    };\r\n    ProgressUI.prototype.ready = function () {\r\n        if (!this.splash) {\r\n            return;\r\n        }\r\n        if (this.config.start) {\r\n            this.splash.style.background = \"url(\".concat(this.config.start, \")\");\r\n        }\r\n        Object.assign(this.prRoot.style, {\r\n            visibility: \"hidden\",\r\n            opacity: 0,\r\n        });\r\n    };\r\n    ProgressUI.prototype.hide = function (dispose) {\r\n        var _this = this;\r\n        if (dispose === void 0) { dispose = false; }\r\n        if (!this.splash) {\r\n            return;\r\n        }\r\n        Object.assign(this.prRoot.style, {\r\n            visibility: \"hidden\",\r\n            opacity: 0,\r\n        });\r\n        Object.assign(this.splash.style, {\r\n            visibility: \"hidden\",\r\n            opacity: 0,\r\n        });\r\n        var promise = new Promise(function (res) { return setTimeout(res, 500); });\r\n        if (!dispose) {\r\n            return promise;\r\n        }\r\n        return promise.then(function () { return _this.dispose(); });\r\n    };\r\n    ProgressUI.prototype.dispose = function () {\r\n        if (!this.splash) {\r\n            return;\r\n        }\r\n        window.removeEventListener('resize', this.onUpdate);\r\n        this.splash.remove();\r\n        this.prRoot.remove();\r\n        this.splash = null;\r\n    };\r\n    return ProgressUI;\r\n}());\r\nexport { ProgressUI };\r\n","import { Reporter } from \"./reporter\";\r\nvar Runner = /** @class */ (function () {\r\n    function Runner(loader, config) {\r\n        this.loader = loader;\r\n        this.config = config;\r\n    }\r\n    ;\r\n    Runner.prototype.runGame = function (progressEvent) {\r\n        if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\r\n        var config = this.config;\r\n        var bins = config.binary =\r\n            (Array.isArray(config.binary)\r\n                ? config.binary\r\n                : [config.binary]).map(function (e) { return (typeof e === 'string' ? { path: e } : e); });\r\n        var jss = config.runtime =\r\n            (Array.isArray(config.runtime)\r\n                ? config.runtime\r\n                : [config.runtime]).map(function (e) { return (typeof e === 'string' ? { path: e, type: 'js' } : e); });\r\n        var loadReporter = new Reporter(null, null, 4);\r\n        var avmReporter = new Reporter(function (f) {\r\n            console.log(\"AVM Load\", f);\r\n        }, null, config.progressParserWeigth ? config.progressParserWeigth : 0.001);\r\n        this.progress = new Reporter(progressEvent, [loadReporter, avmReporter]);\r\n        // make functions avilailable on window, so the loaded js-code can access and execute them\r\n        Object.assign(window, {\r\n            updatePokiProgressBar: avmReporter.report,\r\n            //pokiGameParseComplete: complete,\r\n        });\r\n        return this.loader.run(jss, bins, loadReporter.report, config.debug).then(function (data) {\r\n            config.files = data;\r\n            return config;\r\n        });\r\n    };\r\n    return Runner;\r\n}());\r\nexport { Runner };\r\n"],"names":["supportDecoderApi","self","isSWC","head","outputSize","DataView","buffer","getUint32","Fetcher","url","progress","f","reader","total","chunks","fetch","then","request","headers","get","body","getReader","read","data","firstChunk","value","console","debug","String","fromCharCode","apply","slice","reverse","decoder","loaded","totalDecodedSize","swcHeader","size","offset","donableCallback","DecompressionStream","decoderW","writable","getWriter","decoderR","readable","Uint8Array","isRunned","isDone","run","next","state","done","set","length","write","ready","readAll","Promise","resolve","res","Decoder","push","Math","min","moveNext","buffer_1","offset_1","forEach","e","loadBinary","file","progressEvent","isScript","path","indexOf","Object","assign","type","req","XMLHttpRequest","addEventListener","getResponseHeader","log","open","responseType","rej","b","Blob","response","loadScript","URL","createObjectURL","undefined","meta","name","resourceType","send","document","querySelector","script","createElement","async","src","onload","onerror","appendChild","runner","loader","ui","Reporter","callback","_childs","weight","this","id","ID","_report","bind","childs","defineProperty","prototype","chs","_i","_a","old","_b","chs_1","c","enumerable","configurable","v","summ_1","v_1","Loader","config","jsFiles","binaryFiles","_debugScripts","_f","pendings","jsCount","binCount","all","concat","reporters","Array","from","map","i","report","filter","transformRel","val","base","includes","parseFloat","ProgressUI","root","onUpdate","onProgress","window","build","splash","prRoot","prLine","init","style","backgroundImage","visibility","pr_conf","rect","background","back","left","top","width","height","line","p","direction","x","innerWidth","y","innerHeight","w","h","minMax","rw","ceil","rh","rx","ry","start","opacity","hide","dispose","_this","promise","setTimeout","removeEventListener","remove","Runner","runGame","bins","binary","isArray","jss","runtime","loadReporter","avmReporter","progressParserWeigth","updatePokiProgressBar","files","LegacyLoader","_gameConfig","setStageDimensions","completeEvent","gameRunEvent","conf","complete","func","_e","once","swfParseComplete"],"mappings":"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"}