{"version":3,"file":"loader.js","sources":["../src/loader/decompress.ts","../src/loader/fetcher.ts","../src/loader/reporter.ts","../src/loader/index.ts","../src/loader/loader.ts","../src/loader/progressUI.ts","../src/loader/runner.ts"],"sourcesContent":["export var supportDecoderApi = ('DecompressionStream' in self);\nexport var isSWC = function (head) { return (head[0] === 0x43 && head[1] === 0x57 && head[2] === 0x53); };\nexport var outputSize = function (head) { return new DataView(head.buffer).getUint32(4, true); };\n/*\ndeclare global {\n    interface Window { DecompressionStream: any; }\n}*/\nexport function Decoder(size, offset) {\n    if (offset === void 0) { offset = 8; }\n    if (!supportDecoderApi) {\n        throw 'Your browser not support DecompressionStream =(';\n    }\n    var decoder = new self.DecompressionStream('deflate');\n    var decoderW = decoder.writable.getWriter();\n    var decoderR = decoder.readable.getReader();\n    var buffer = new Uint8Array(size);\n    var isRunned = false;\n    var isDone = false;\n    var donableCallback;\n    function run() {\n        decoderR.read().then(function next(state) {\n            var done = state.done;\n            var value = state.value;\n            if (value) {\n                buffer.set(value, offset);\n                //console.debug(\"[Loader] Decoded chunk:\", offset);\n                offset += value.length;\n            }\n            if (done || offset >= size) {\n                isDone = true;\n                if (donableCallback) {\n                    donableCallback();\n                }\n                console.debug(\"[Loader] Decoder closed:\", offset);\n                return;\n            }\n            return decoderR.read().then(next);\n        });\n    }\n    return {\n        get buffer() {\n            return buffer;\n        },\n        write: function (buffer) {\n            decoderW.ready.then(function () {\n                decoderW.write(buffer);\n                if (!isRunned) {\n                    isRunned = true;\n                    run();\n                }\n            });\n        },\n        readAll: function () {\n            if (isDone) {\n                return Promise.resolve(buffer);\n            }\n            return new Promise(function (res) {\n                donableCallback = function () {\n                    res(buffer);\n                };\n            });\n        }\n    };\n}\n","import { supportDecoderApi, isSWC, outputSize, Decoder } from './decompress';\nexport function Fetcher(url, progress) {\n    if (url === void 0) { url = ''; }\n    if (progress === void 0) { progress = function (f) { return f; }; }\n    var total = 0;\n    var reader;\n    var chunks = [];\n    progress && progress(0);\n    return fetch(url)\n        .then(function (request) {\n        total = +request.headers.get('Content-Length');\n        reader = request.body.getReader();\n        return reader.read();\n    })\n        .then(function (data) {\n        var firstChunk = data.value;\n        console.debug(\"[Loader] Header:\", String.fromCharCode.apply(null, firstChunk.slice(0, 3).reverse()));\n        var loaded = 0;\n        var decoder;\n        if (supportDecoderApi && isSWC(firstChunk)) {\n            var totalDecodedSize = outputSize(firstChunk);\n            var swcHeader = firstChunk.slice(0, 8);\n            swcHeader[0] = 70; // SWC => SWF\n            console.debug(\"[Loader] SWC size:\", outputSize(firstChunk));\n            decoder = Decoder(totalDecodedSize, 8);\n            decoder.buffer.set(swcHeader);\n            // push witout header\n            decoder.write(firstChunk.slice(8));\n        }\n        else {\n            chunks.push(firstChunk);\n        }\n        loaded += firstChunk.length;\n        progress && progress(Math.min(1, loaded / total));\n        // update all other chunks reqursive while !done\n        return reader.read().then(function moveNext(state) {\n            if (state.done) {\n                if (!decoder) {\n                    var buffer_1 = new Uint8Array(loaded);\n                    var offset_1 = 0;\n                    chunks.forEach(function (e) {\n                        buffer_1.set(e, offset_1);\n                        offset_1 += e.length;\n                    });\n                    return buffer_1;\n                }\n                else {\n                    return decoder.readAll();\n                }\n            }\n            var value = state.value;\n            loaded += value.length;\n            progress && progress(loaded / total);\n            if (!decoder) {\n                chunks.push(value);\n            }\n            else {\n                decoder.write(value);\n            }\n            return reader.read().then(moveNext);\n        });\n    });\n}\nexport function loadBinary(file, progressEvent) {\n    if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\n    var isScript = file.path.indexOf(\".js\") > -1;\n    if (!isScript && supportDecoderApi) {\n        return Fetcher(file.path, progressEvent).then(function (buffer) {\n            return Object.assign(file, {\n                data: buffer.buffer,\n                type: \"swf\",\n            });\n        });\n    }\n    var req = new XMLHttpRequest();\n    req.addEventListener(\"progress\", function (e) {\n        // get from progress, then from request, and if not valid - from file\n        var total = e.total\n            || +req.getResponseHeader(\"content-length\")\n            || file.size\n            || 0;\n        if (!total) {\n            progressEvent(1);\n            return;\n        }\n        console.log(\"XHR\", e.loaded, total);\n        progressEvent(Math.min(1, e.loaded / total));\n    });\n    req.open(\"GET\", file.path, true);\n    req.responseType = isScript ? \"text\" : \"arraybuffer\";\n    return new Promise(function (res, rej) {\n        req.addEventListener(\"error\", rej);\n        req.addEventListener(\"load\", function () {\n            progressEvent(1);\n            if (isScript) {\n                // unsafe\n                //eval(req.response);\n                var b = new Blob([req.response], { type: \"text/javascript\" });\n                // use blob\n                loadScript(URL.createObjectURL(b)).then(function () { return res(undefined); });\n                return;\n            }\n            res({\n                meta: file.meta || {},\n                name: file.name,\n                path: file.path,\n                resourceType: file.resourceType,\n                data: req.response,\n                type: isScript ? \"js\" : \"swf\",\n            });\n        });\n        req.send();\n    });\n}\nexport function loadScript(file, progress) {\n    var head = document.querySelector(\"head\");\n    var script = document.createElement(\"script\");\n    return new Promise(function (res, rej) {\n        Object.assign(script, {\n            type: \"text/javascript\",\n            async: true,\n            src: typeof file === 'string' ? file : file.path,\n            onload: function () {\n                progress && progress(1);\n                res(script);\n            },\n            onerror: rej,\n        });\n        head.appendChild(script);\n    });\n}\n","var Reporter = /** @class */ (function () {\n    function Reporter(callback, _childs, weight) {\n        if (weight === void 0) { weight = 1; }\n        this.callback = callback;\n        this.weight = weight;\n        this.id = Reporter.ID++;\n        this.value = 0;\n        this._childs = [];\n        this._report = this._report.bind(this);\n        this.childs = _childs;\n    }\n    Object.defineProperty(Reporter.prototype, \"childs\", {\n        get: function () {\n            return this._childs;\n        },\n        set: function (chs) {\n            for (var _i = 0, _a = this._childs; _i < _a.length; _i++) {\n                var old = _a[_i];\n                if (old.callback === this._report) {\n                    old.callback = null;\n                }\n            }\n            this._childs.length = 0;\n            if (chs) {\n                for (var _b = 0, chs_1 = chs; _b < chs_1.length; _b++) {\n                    var c = chs_1[_b];\n                    if (c === this)\n                        throw 'Reporter loop';\n                    c.callback = this._report;\n                }\n                this._childs = chs.slice();\n            }\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Reporter.prototype._report = function (v) {\n        if (this._childs.length === 0) {\n            this.value = v * this.weight;\n        }\n        else {\n            var summ_1 = 0;\n            var v_1 = 0;\n            this._childs.forEach(function (e) {\n                summ_1 += e.weight || 1;\n                v_1 += (e.value || 0);\n            });\n            this.value = v_1 / summ_1;\n        }\n        this.callback && this.callback(this.value);\n    };\n    Object.defineProperty(Reporter.prototype, \"report\", {\n        get: function () {\n            return this._report;\n        },\n        enumerable: false,\n        configurable: true\n    });\n    Reporter.ID = 0;\n    return Reporter;\n}());\nexport { Reporter };\n","import { Loader } from \"./loader\";\nimport { ProgressUI } from \"./progressUI\";\nimport { Runner } from \"./runner\";\nimport { Reporter } from \"./reporter\";\nexport { Loader, Runner, ProgressUI, Reporter };\nvar runner;\nvar loader;\nvar ui;\nexport var LegacyLoader = {\n    init: function (_gameConfig) {\n        loader = new Loader(_gameConfig);\n        runner = new Runner(loader, _gameConfig);\n        ui = new ProgressUI(document, _gameConfig);\n        ui.init();\n        window[\"setStageDimensions\"] = function (x, y, w, h) {\n            _gameConfig.x = x;\n            _gameConfig.y = y;\n            _gameConfig.w = w;\n            _gameConfig.h = h;\n            if (window[\"AVMPlayerPoki\"]) {\n                window[\"AVMPlayerPoki\"].setStageDimensions(x, y, w, h);\n            }\n            ui.onUpdate();\n        };\n    },\n    runGame: function (progressEvent, completeEvent) {\n        if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\n        if (completeEvent === void 0) { completeEvent = function (data, gameRunEvent) { return 0; }; }\n        var conf = runner.config;\n        var progress = function (f) {\n            console.log(\"progress:\", f);\n            ui.onProgress(f);\n            progressEvent(f);\n        };\n        var complete = function (func) {\n            // rereport\n            // completeEvent(func);\n            if (conf.start) {\n                //\tstart image exists.\n                //\thide progressbar, show startimage and wait for user-input to start the game\n                ui.ready();\n                var onCLick = function (_e) {\n                    ui.hide(true);\n                    if (!func)\n                        throw \"PokiPlayer did not send a callback for starting game\";\n                    func();\n                };\n                window.addEventListener(\"click\", onCLick, { once: true });\n            }\n            else {\n                ui.hide(true);\n            }\n        };\n        // make functions avilailable on window, so the loaded js-code can access and execute them\n        Object.assign(window, {\n            swfParseComplete: complete,\n        });\n        return runner\n            .runGame(progress)\n            .then(function (res) {\n            completeEvent(res, complete);\n        });\n    }\n};\n","import { loadBinary, loadScript } from \"./fetcher\";\nimport { Reporter } from \"./reporter\";\nvar Loader = /** @class */ (function () {\n    function Loader(config) {\n        this.config = config;\n    }\n    ;\n    Loader.prototype.run = function (jsFiles, binaryFiles, progressEvent, _debugScripts) {\n        if (progressEvent === void 0) { progressEvent = function (_f) { return void 0; }; }\n        if (_debugScripts === void 0) { _debugScripts = false; }\n        var jsCount = jsFiles.length;\n        var binCount = binaryFiles.length;\n        var all = jsFiles.concat(binaryFiles);\n        var reporters = Array.from({ length: jsCount + binCount }, function () { return new Reporter(); });\n        this.progress = new Reporter(progressEvent, reporters);\n        var pendings;\n        if (!_debugScripts) {\n            pendings = all.map(function (e, i) { return loadBinary(e, reporters[i].report); });\n        }\n        else {\n            pendings = binaryFiles.map(function (e, i) { return loadBinary(e, reporters[i].report); });\n            pendings = pendings.concat(jsFiles.map(function (e, i) { return loadScript(e, reporters[i + binCount].report); }));\n        }\n        return Promise.all(pendings).then(function (data) {\n            return data.filter(function (e) { return e && e.type === \"swf\"; });\n        });\n    };\n    return Loader;\n}());\nexport { Loader };\n","var transformRel = function (val, base) {\n    if (typeof val !== 'string')\n        return +val;\n    return val.includes(\"%\")\n        ? (parseFloat(val) / 100) * base\n        : parseFloat(val);\n};\nvar ProgressUI = /** @class */ (function () {\n    function ProgressUI(root, config) {\n        if (root === void 0) { root = document; }\n        this.root = root;\n        this.config = config;\n        this.onUpdate = this.onUpdate.bind(this);\n        this.onProgress = this.onProgress.bind(this);\n        window.addEventListener(\"resize\", this.onUpdate);\n    }\n    ProgressUI.prototype.build = function () {\n        this.splash = this.root.querySelector(\"#splash__image\");\n        this.prRoot = this.root.querySelector(\"#progress__root\");\n        this.prLine = this.root.querySelector(\"#progress__line\");\n    };\n    ProgressUI.prototype.init = function () {\n        this.build();\n        if (!this.splash) {\n            return;\n        }\n        var config = this.config;\n        Object.assign(this.splash.style, {\n            backgroundImage: \"url(\".concat(config.splash, \")\"),\n            visibility: \"visible\",\n        });\n        var pr_conf = config.progress;\n        pr_conf.rect = pr_conf.rect || [0.1, 0.9, 0.8, 0.01];\n        Object.assign(this.prRoot.style, {\n            background: pr_conf.back,\n            left: \"\".concat(100 * pr_conf.rect[0], \"%\"),\n            top: \"\".concat(100 * pr_conf.rect[1], \"%\"),\n            width: \"\".concat(100 * pr_conf.rect[2], \"%\"),\n            height: \"\".concat(100 * pr_conf.rect[3], \"%\"),\n        });\n        Object.assign(this.prLine.style, {\n            background: pr_conf.line,\n        });\n        this.onUpdate();\n    };\n    ProgressUI.prototype.onProgress = function (p) {\n        if (!this.prLine) {\n            return;\n        }\n        var pr_conf = this.config.progress;\n        switch (pr_conf.direction) {\n            case \"tb\": {\n                Object.assign(this.prLine.style, {\n                    height: \"\".concat(p * 100, \"%\"),\n                    width: \"100%\",\n                });\n                break;\n            }\n            case \"lr\":\n            default: {\n                Object.assign(this.prLine.style, {\n                    height: \"100%\",\n                    width: \"\".concat(p * 100, \"%\"),\n                });\n            }\n        }\n    };\n    ProgressUI.prototype.onUpdate = function () {\n        if (!this.splash) {\n            return;\n        }\n        var config = this.config;\n        var x = transformRel(config.x, window.innerWidth) || 0;\n        var y = transformRel(config.y, window.innerHeight) || 0;\n        var w = transformRel(config.w, window.innerWidth) || window.innerWidth;\n        var h = transformRel(config.h, window.innerHeight) || window.innerHeight;\n        var minMax = Math.min(h / config.height, w / config.width);\n        var rw = Math.ceil(config.width * minMax);\n        var rh = Math.ceil(config.height * minMax);\n        var rx = x + (w - rw) / 2;\n        var ry = y + (h - rh) / 2;\n        Object.assign(this.splash.style, {\n            width: \"\".concat(rw, \"px\"),\n            height: \"\".concat(rh, \"px\"),\n            left: \"\".concat(rx, \"px\"),\n            top: \"\".concat(ry, \"px\"),\n        });\n    };\n    ProgressUI.prototype.ready = function () {\n        if (!this.splash) {\n            return;\n        }\n        if (this.config.start) {\n            this.splash.style.background = \"url(\".concat(this.config.start, \")\");\n        }\n        Object.assign(this.prRoot.style, {\n            visibility: \"hidden\",\n            opacity: 0,\n        });\n    };\n    ProgressUI.prototype.hide = function (dispose) {\n        var _this = this;\n        if (dispose === void 0) { dispose = false; }\n        if (!this.splash) {\n            return;\n        }\n        Object.assign(this.prRoot.style, {\n            visibility: \"hidden\",\n            opacity: 0,\n        });\n        Object.assign(this.splash.style, {\n            visibility: \"hidden\",\n            opacity: 0,\n        });\n        var promise = new Promise(function (res) { return setTimeout(res, 500); });\n        if (!dispose) {\n            return promise;\n        }\n        return promise.then(function () { return _this.dispose(); });\n    };\n    ProgressUI.prototype.dispose = function () {\n        if (!this.splash) {\n            return;\n        }\n        window.removeEventListener('resize', this.onUpdate);\n        this.splash.remove();\n        this.prRoot.remove();\n        this.splash = null;\n    };\n    return ProgressUI;\n}());\nexport { ProgressUI };\n","import { Reporter } from \"./reporter\";\nvar Runner = /** @class */ (function () {\n    function Runner(loader, config) {\n        this.loader = loader;\n        this.config = config;\n    }\n    ;\n    Runner.prototype.runGame = function (progressEvent) {\n        if (progressEvent === void 0) { progressEvent = function (f) { return f; }; }\n        var config = this.config;\n        var bins = config.binary =\n            (Array.isArray(config.binary)\n                ? config.binary\n                : [config.binary]).map(function (e) { return (typeof e === 'string' ? { path: e } : e); });\n        var jss = config.runtime =\n            (Array.isArray(config.runtime)\n                ? config.runtime\n                : [config.runtime]).map(function (e) { return (typeof e === 'string' ? { path: e, type: 'js' } : e); });\n        var loadReporter = new Reporter(null, null, 4);\n        var avmReporter = new Reporter(function (f) {\n            console.log(\"AVM Load\", f);\n        }, null, config.progressParserWeigth ? config.progressParserWeigth : 0.001);\n        this.progress = new Reporter(progressEvent, [loadReporter, avmReporter]);\n        // make functions avilailable on window, so the loaded js-code can access and execute them\n        Object.assign(window, {\n            updatePokiProgressBar: avmReporter.report,\n            //pokiGameParseComplete: complete,\n        });\n        return this.loader.run(jss, bins, loadReporter.report, config.debug).then(function (data) {\n            config.files = data;\n            return config;\n        });\n    };\n    return Runner;\n}());\nexport { Runner };\n"],"names":["supportDecoderApi","self","isSWC","head","outputSize","DataView","buffer","getUint32","Fetcher","url","progress","f","reader","total","chunks","fetch","then","request","headers","get","body","getReader","read","data","firstChunk","value","console","debug","String","fromCharCode","apply","slice","reverse","decoder","loaded","totalDecodedSize","swcHeader","size","offset","donableCallback","DecompressionStream","decoderW","writable","getWriter","decoderR","readable","Uint8Array","isRunned","isDone","run","next","state","done","set","length","write","ready","readAll","Promise","resolve","res","Decoder","push","Math","min","moveNext","buffer_1","offset_1","forEach","e","loadBinary","file","progressEvent","isScript","path","indexOf","Object","assign","type","req","XMLHttpRequest","addEventListener","getResponseHeader","log","open","responseType","rej","b","Blob","response","loadScript","URL","createObjectURL","undefined","meta","name","resourceType","send","document","querySelector","script","createElement","async","src","onload","onerror","appendChild","runner","loader","ui","Reporter","callback","_childs","weight","this","id","ID","_report","bind","childs","defineProperty","prototype","chs","_i","_a","old","_b","chs_1","c","enumerable","configurable","v","summ_1","v_1","Loader","config","jsFiles","binaryFiles","_debugScripts","_f","pendings","jsCount","binCount","all","concat","reporters","Array","from","map","i","report","filter","transformRel","val","base","includes","parseFloat","ProgressUI","root","onUpdate","onProgress","window","build","splash","prRoot","prLine","init","style","backgroundImage","visibility","pr_conf","rect","background","back","left","top","width","height","line","p","direction","x","innerWidth","y","innerHeight","w","h","minMax","rw","ceil","rh","rx","ry","start","opacity","hide","dispose","_this","promise","setTimeout","removeEventListener","remove","Runner","runGame","bins","binary","isArray","jss","runtime","loadReporter","avmReporter","progressParserWeigth","updatePokiProgressBar","files","LegacyLoader","_gameConfig","setStageDimensions","completeEvent","gameRunEvent","conf","complete","func","_e","once","swfParseComplete"],"mappings":"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"}